extends _base

block content
  section.content-header
    .container-fluid
      h1(onclick="renameDevice()", style="cursor:pointer")
        = title

  if cmdonlycapabilitycomponents
    .row
      each component, key in cmdonlycapabilitycomponents
        .col-md-4
          .card.card-lightblue
            .card-header
              h3.card-title
                = key.toUpperCase() 
                small
                  |  · command only
            .card-body
              each command in component
                if command.includes("?")
                  button.btn.btn-lg.btn-success(onclick="executeCmd('" + device.Name + "', '" + key + "')")
                    = command.replace("?", " ...").toUpperCase()
                else
                  button.btn.btn-lg.btn-success(onclick="executeCmd('" + device.Name + "', '" + key + "', '" + command + "')")
                    = command.toUpperCase()

  each component, key in statcapabilitycomponents
    .row
      .col-md-12
        .card.card-lightblue
          .card-header
            h3.card-title
              = key.toUpperCase() 
              small
                |  · stat and command
            .card-tools
              .btn-group
                button.btn.btn-default.btn-sm(type='button', onclick='statmode.' + key + ' = 1; LoadStatGraph_' + key + '();') Daily
                button.btn.btn-default.btn-sm(type='button', onclick='statmode.' + key + ' = 7; LoadStatGraph_' + key + '();') Weekly
                button.btn.btn-default.btn-sm(type='button', onclick='statmode.' + key + ' = 30; LoadStatGraph_' + key + '();') Monthly
          .card-body
            .row
              .col-md-2
                h1
                  = (ctxdevice.stat(key) || "?").toUpperCase()
              .col-md-4
                if component
                  each command in component
                    button.btn.btn-lg.btn-success(onclick="$.post('/device/" + device.Name + "/" + key + "', { command: '" + command + "' });")
                      = command.toUpperCase()
            .row
              .col-md-1
                h5.float-right
                  br
                  .badge.badge-info(id="statpercent_" + key)
                  br
                  small(id="stattime_" + key)
              .col-md-11
                div(style="height: 120px;", id="stat_" + key)

  each component, key in telecapabilitycomponents
    .row
      .col-md-12
        .card.card-lightblue
          .card-header
            h3.card-title
              = key.toUpperCase()
            .card-tools
              .btn-group
                button.btn.btn-default.btn-sm(type='button', onclick='telemode.' + key + ' = 1; LoadTeleGraph_' + key + '();') Daily
                button.btn.btn-default.btn-sm(type='button', onclick='telemode.' + key + ' = 7; LoadTeleGraph_' + key + '();') Weekly
                button.btn.btn-default.btn-sm(type='button', onclick='telemode.' + key + ' = 30; LoadTeleGraph_' + key + '();') Monthly
          .card-body
            .row
              .col-md-2
                h1
                  = (ctxdevice.tele(key) !== undefined ? ctxdevice.tele(key) : "?")
                  small 
                    = ctxdevice.metric(key)
              .col-md-10
                div(style="height: 300px;", id="tele_" + key)

  .row
    .col-md-4
      .card.card-info.h-100
        .card-header
          h3.card-title Status
            small
              if devicesys
                =" · "
                = moment(devicesys.DateTime).fromNow()
        .card-body
          if !devicesys || !devicesys.Items || !devicesys.Items.length
            | Not arrived yet...
          else
            each devicesysitem in devicesys.Items
              .row
                .col-sm-4
                  = devicesysitem.Name
                .col-sm-8
                  b
                    = devicesysitem.Value
                  if (devicesysitem.SubValue)
                    small
                      = devicesysitem.SubValue
                  if (devicesysitem.ValueLink)
                    small
                      a(target='_blank' href=devicesysitem.ValueLink) 
                        i.fa.fa-external-link-alt
    .col-md-4
      .card.card-warning.h-100
        .card-header
          h3.card-title Last event
          .card-tools
            .btn-group
              a.btn.btn-default.btn-xs(href='/device/' + device.Name + '/timeline') Timeline
        .card-body
          if !devicelastevents || !devicelastevents.length
            | No events
          else
            each devicelastevent in devicelastevents
              .row
                .col-sm-6
                  .badge.badge-info
                    = devicelastevent.Event
                .col-sm-6
                  b
                    = devicelastevent.Data
                  br
                  small
                    = moment(devicelastevent.DateTime).fromNow()
    .col-md-4
      .card.card-olive.h-100
        .card-header
          h3.card-title Config
          .card-tools
            .btn-group
              button.btn.btn-default.btn-xs(onclick='$.post("/device/' + device.Name + '/config/push", null);')
                i.fas.fa-retweet
                |  Push to device
              button.btn.btn-primary.btn-xs(onclick='addConfig()')
                i.fas.fa-plus
                |  Add
        .card-body
          if !deviceconfigs || !deviceconfigs.length
            | No special config
          else
            each deviceconfig in deviceconfigs
              .row
                .col-sm-4
                  = deviceconfig.Name
                .col-sm-8
                  b(style='cursor:pointer', onclick='modifyConfig(' + deviceconfig.Id + ', "' + deviceconfig.Value + '")')
                    = deviceconfig.Value
                  .float-right
                    i.fa.fa-times.text-danger(style='cursor:pointer', onclick='deleteConfig(' + deviceconfig.Id + ', "' + deviceconfig.Name + '")')

  br

  .row
    .col-md-4
      .card.card-maroon.h-100
        .card-header
          h3.card-title MQTT Capability
        .card-body
          if !devicecapabilities || !devicecapabilities.length
            | Cannot determine yet...
          else
            each devicecapability in devicecapabilities
              .row
                if devicecapability.Items
                  .col-md-4
                    = devicecapability.Value
                  .col-md-8
                    if devicecapability.Items
                      | &nbsp;&nbsp;
                      each devicecapitem in devicecapability.Items
                        span.badge.badge-info
                          = devicecapitem
                        | &nbsp;&nbsp;
                else 
                  .col-md-12
                    = devicecapability.Value
          center
            button.btn.btn-danger.btn-sm(onclick='deleteDevice()')
              i.fas.fa-ban
              |  Delete device


  br

  script(type='text/javascript')
    | function pagereload() { divreload('content-wrapper', () => {
    each component, key in statcapabilitycomponents
      | LoadStatGraph_#{key}();
    each component, key in telecapabilitycomponents
      | LoadTeleGraph_#{key}();
    |}) };
    | subscribes = { #{devicename} : pagereload() }
  script(src='/plugins/jquery/jquery.min.js')
  script(src='/plugins/flot/jquery.flot.js')
  script(src='/plugins/flot-old/jquery.flot.resize.min.js')

  script(type='text/javascript')
    | var statmode = 
    | {
    each component, key in statcapabilitycomponents
      | #{key}: 1,
    | };
  script(type='text/javascript')
    | var telemode = 
    | {
    each component, key in telecapabilitycomponents
      | #{key}: 1,
    | };

  each component, key in statcapabilitycomponents
    script(type='text/javascript').
      
      function LoadStatGraph_#{key}() {
        var days = statmode.#{key};
        var url = "/device/#{device.Name}/graph/stat/#{key}/" + days;
        var timeformat = days > 1 ? "%b %d." : "%H:%M";
        var minTickSize = days > 1 ? (days > 15 ? [7, "day"] : [1, "day"]) : null;
        
        $.get(url, function(data)
        {
          var data = JSON.parse(data);
          
          var timeline = data.timeline;
          var time = data.time;
          var percent = data.percent;
          
          $('#stattime_#{key}').html(time);
          $('#statpercent_#{key}').html(percent + " %");

          var interactive_plot = $.plot('#stat_#{key}',
          [
            {
              data: timeline,
            },
          ],
          {
            grid: {
              borderColor: '#f3f3f3',
              borderWidth: 1,
              tickColor: '#f3f3f3',
              autoHighlight: true,
            },
            series: {
              color: '#3c8dbc',
              lines: {
                lineWidth: 1,
                show: true,
                fill: true,
              },
            },
            yaxis: {
              show: false,
            },
            xaxis: {
              show: true,
              mode: "time",
              timezone: "browser",
              timeBase: "milliseconds",
              timeformat: timeformat,
              minTickSize: minTickSize,
              showTicks: true,
            }
          });
        })
      };
      
      $(function () {
        LoadStatGraph_#{key}();
      });
      
  each component, key in telecapabilitycomponents
    script(type='text/javascript').
      
      function LoadTeleGraph_#{key}() {
        var days = telemode.#{key};
        var url = "/device/#{device.Name}/graph/tele/#{key}/" + days;
        var timeformat = days > 1 ? "%b %d." : "%H:%M";
        var minTickSize = days > 1 ? (days > 15 ? [7, "day"] : [1, "day"]) : null;
        
        $.get(url, function(data)
        {
          var timeline = JSON.parse(data);

          var interactive_plot = $.plot('#tele_#{key}',
          [
            {
              data: timeline,
            },
          ],
          {
            grid: {
              borderColor: '#f3f3f3',
              borderWidth: 1,
              tickColor: '#f3f3f3',
              autoHighlight: true,
            },
            series: {
              color: '#3c8dbc',
              lines: {
                lineWidth: 1,
                show: true,
                fill: false,
              },
            },
            yaxis: {
              show: true,
            },
            xaxis: {
              show: true,
              mode: "time",
              timezone: "browser",
              timeBase: "milliseconds",
              timeformat: timeformat,
              minTickSize: minTickSize,
              showTicks: true,
            }
          });
        })
      };
      
      $(function () {
        LoadTeleGraph_#{key}();
      });

  script(type='text/javascript').
    function executeCmd(devicename, key, command)
    {
      if (command)
        $.post("/device/" + devicename + "/" + key, { command: command });
      else
        bootbox.prompt({
          title: "Command param of " + key,
          callback: function(result)
          {
            if (result)
              $.post("/device/" + devicename + "/" + key, { command: result });
          }
        });
    }
    
    function addConfig()
    {
      $.get('/device/form/config/add', function(form)
      {
        var dialog = bootbox.dialog({
            title: 'Add new device config',
            message: form,
            buttons: {
              Cancel: {
                    label: "Cancel",
                    className: 'btn-default',
              },
              OK: {
                    label: "OK",
                    className: 'btn-primary',
                    callback: function()
                    {
                        var name = $('#name').val();
                        var value = $('#value').val();
                        
                        if (name && value)
                          $.post("/device/#{device.Name}/config/add", { name: name, value: value })
                            .done(function() {
                              bootbox.hideAll();
                              pagereload();
                            });
                        return false;
                    },
              },
            }
        });
      });
    }

    function modifyConfig(id, value)
    {
      $.get('/device/form/config/modify', function(form)
      {
        var dialog = bootbox.dialog({
            title: 'Modify device config',
            message: form,
            buttons: {
              Cancel: {
                    label: "Cancel",
                    className: 'btn-default',
              },
              OK: {
                    label: "OK",
                    className: 'btn-primary',
                    callback: function()
                    {
                        var value = $('#value').val();

                        $.post("/device/#{device.Name}/config/modify", { id: id, value: value })
                          .done(function() {
                            bootbox.hideAll();
                            pagereload();
                          });
                        return false;
                    },
              },
            }
        });
        $('#value').val(value);
      });
    }

    function deleteConfig(id, name)
    {
      bootbox.confirm("Are you sure to delete config <b>" + name + "</b>?", function(result) {
        if (result)
        {
          $.post("/device/#{device.Name}/config/delete", { id: id })
            .done(function() {
              pagereload();
            });
        }
      })
    }
    
    function renameDevice()
    {
      bootbox.prompt({
        title: "Rename device [#{device.Name}]",
        value: "#{device.DisplayName || device.Name}",
        callback: function(result)
        {
          if (result)
            $.post("/device/#{device.Name}/setdisplayname", { displayname: result })
              .done(function() {
                pagereload();
              });
        }
      });
    }

    function deleteDevice()
    {
      bootbox.confirm("All settings and history information will be lost permanently!<br/><br/>Are you sure to delete device <b>#{device.Name}</b>?", function(result) {
        if (result)
        {
          $.post("/device/#{device.Name}/delete")
            .done(function() {
              window.location.href = '/';
            });
        }
      })
    }
    